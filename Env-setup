#!/bin/bash

# Quick Setup Script for DB Sentinel in Stress Environment

# This script provides a faster, simplified installation for testing

set -e

# Colors

GREEN=â€™\033[0;32mâ€™
YELLOW=â€™\033[1;33mâ€™
RED=â€™\033[0;31mâ€™
NC=â€™\033[0mâ€™

echo -e â€œ${GREEN}ðŸš€ DB Sentinel Stress Environment Setup${NC}â€
echo â€œ================================================â€

# Check if weâ€™re in the right directory

if [[ ! -f â€œDB_Sentinel_utility_refreshed.pyâ€ ]]; then
echo -e â€œ${RED}âŒ Error: DB Sentinel files not found in current directory${NC}â€
echo â€œPlease ensure all .py files are in the current directory and run again.â€
exit 1
fi

# Step 1: Create simple working directory

echo -e â€œ${GREEN}ðŸ“ Setting up working directoryâ€¦${NC}â€
WORK_DIR=â€$HOME/db_sentinel_stressâ€
mkdir -p $WORK_DIR
cp *.py $WORK_DIR/
cp config.yaml $WORK_DIR/ 2>/dev/null || cp config_template.yaml $WORK_DIR/config.yaml

cd $WORK_DIR
echo â€œWorking directory: $WORK_DIRâ€

# Step 2: Check Python and install packages

echo -e â€œ${GREEN}ðŸ Setting up Python environmentâ€¦${NC}â€
if ! command -v python3 &> /dev/null; then
echo -e â€œ${RED}âŒ Python 3 not found. Please install Python 3.8+${NC}â€
exit 1
fi

# Create virtual environment

python3 -m venv venv
source venv/bin/activate

# Install required packages

echo â€œInstalling Python packagesâ€¦â€
pip install â€“quiet oracledb pandas tqdm pyyaml

echo -e â€œ${GREEN}âœ… Python environment ready${NC}â€

# Step 3: Configure environment variables

echo -e â€œ${GREEN}ðŸ” Setting up database credentialsâ€¦${NC}â€
echo â€œâ€
echo â€œPlease provide your database connection details:â€
echo â€œâ€

read -p â€œSource DB hostname: â€œ SOURCE_HOST
read -p â€œSource DB service name: â€œ SOURCE_SERVICE
read -p â€œSource DB username: â€œ SOURCE_USER
read -s -p â€œSource DB password: â€œ SOURCE_PASS
echo â€œâ€

read -p â€œTarget DB hostname: â€œ TARGET_HOST
read -p â€œTarget DB service name: â€œ TARGET_SERVICE
read -p â€œTarget DB username: â€œ TARGET_USER
read -s -p â€œTarget DB password: â€œ TARGET_PASS
echo â€œâ€

# Create environment file

cat > .env << EOF

# DB Sentinel Environment Variables for Stress Testing

export DB_SENTINEL_SOURCE_PASSWORD=â€™$SOURCE_PASSâ€™
export DB_SENTINEL_TARGET_PASSWORD=â€™$TARGET_PASSâ€™
EOF

chmod 600 .env

# Step 4: Update configuration file

echo -e â€œ${GREEN}âš™ï¸  Updating configurationâ€¦${NC}â€

# Create a simple config for stress testing

cat > config.yaml << EOF

# DB Sentinel Configuration for Stress Environment

databases:
source:
host: â€œ$SOURCE_HOSTâ€
port: 1521
service_name: â€œ$SOURCE_SERVICEâ€
username: â€œ$SOURCE_USERâ€
password: â€œ${DB_SENTINEL_SOURCE_PASSWORD}â€
connect_timeout: 60
query_timeout: 600

target:
host: â€œ$TARGET_HOSTâ€
port: 1521
service_name: â€œ$TARGET_SERVICEâ€
username: â€œ$TARGET_USERâ€
password: â€œ${DB_SENTINEL_TARGET_PASSWORD}â€
connect_timeout: 60
query_timeout: 600

tables:

# ADD YOUR TABLES HERE - Example:

# - name: â€œyour_table_nameâ€

# schema: â€œyour_schemaâ€

# primary_keys: [â€œidâ€]

# exclude_columns: [â€œlast_updatedâ€]

comparison:
batch_size: 5000
max_workers: 2
enable_parallel_processing: true
include_virtual_columns: false
include_hidden_columns: false

logging:
level: â€œINFOâ€
file_logging: true
console_logging: true

checkpoint:
enabled: true
schema: â€œpublicâ€

verification:
enabled: true

misc:
environment: â€œstressâ€
debug_mode: false
EOF

echo -e â€œ${GREEN}âœ… Configuration file created${NC}â€

# Step 5: Create helper scripts

echo -e â€œ${GREEN}ðŸ“ Creating helper scriptsâ€¦${NC}â€

# Create run script

cat > run_comparison.sh << â€˜EOFâ€™
#!/bin/bash

# Quick run script for DB Sentinel

cd â€œ$( dirname â€œ${BASH_SOURCE[0]}â€ )â€
source .env
source venv/bin/activate

echo â€œðŸš€ Starting DB Sentinel comparisonâ€¦â€
python DB_Sentinel_utility_refreshed.py

echo â€œâ€
echo â€œðŸ“Š Checking resultsâ€¦â€
if [[ -d â€œDB_Sentinel_reportâ€ ]]; then
echo â€œâœ… Reports generated:â€
ls -la DB_Sentinel_report/
fi

if [[ -d â€œDB_Sentinel_sqlâ€ ]]; then
echo â€œâœ… SQL files generated:â€
ls -la DB_Sentinel_sql/
fi
EOF

# Create test script

cat > test_connection.sh << â€˜EOFâ€™
#!/bin/bash

# Test database connectivity

cd â€œ$( dirname â€œ${BASH_SOURCE[0]}â€ )â€
source .env
source venv/bin/activate

echo â€œðŸ” Testing database connectionsâ€¦â€
python test_parameter_binding.py
EOF

# Create config editor helper

cat > edit_config.sh << â€˜EOFâ€™
#!/bin/bash

# Edit configuration file

cd â€œ$( dirname â€œ${BASH_SOURCE[0]}â€ )â€

echo â€œðŸ“ Opening configuration fileâ€¦â€
echo â€œAdd your tables in the â€˜tables:â€™ sectionâ€
echo â€œPress Ctrl+X, then Y, then Enter to save in nanoâ€
echo â€œâ€
read -p â€œPress Enter to continueâ€¦â€

nano config.yaml
EOF

chmod +x *.sh

# Step 6: Test connectivity

echo -e â€œ${GREEN}ðŸ” Testing database connectivityâ€¦${NC}â€
source .env

# Quick connectivity test

if python3 -c â€œ
import sys
sys.path.insert(0, â€˜.â€™)
import os
import oracledb

# Test source connection

try:
conn = oracledb.connect(
user=â€™$SOURCE_USERâ€™,
password=â€™$SOURCE_PASSâ€™,
dsn=â€™$SOURCE_HOST:1521/$SOURCE_SERVICEâ€™
)
print(â€˜âœ… Source database connection successfulâ€™)
conn.close()
except Exception as e:
print(fâ€™âŒ Source database connection failed: {e}â€™)
sys.exit(1)

# Test target connection

try:
conn = oracledb.connect(
user=â€™$TARGET_USERâ€™,
password=â€™$TARGET_PASSâ€™,
dsn=â€™$TARGET_HOST:1521/$TARGET_SERVICEâ€™
)
print(â€˜âœ… Target database connection successfulâ€™)
conn.close()
except Exception as e:
print(fâ€™âŒ Target database connection failed: {e}â€™)
sys.exit(1)
â€œ; then
echo -e â€œ${GREEN}âœ… Database connectivity test passed!${NC}â€
else
echo -e â€œ${YELLOW}âš ï¸  Database connectivity test failed${NC}â€
echo â€œPlease check your database details and network connectivityâ€
fi

# Final instructions

echo â€œâ€
echo -e â€œ${GREEN}ðŸŽ‰ Setup Complete!${NC}â€
echo â€œ================================================â€
echo â€œâ€
echo â€œðŸ“ Installation location: $WORK_DIRâ€
echo â€œâ€
echo â€œðŸ“‹ Next steps:â€
echo â€œ1. Edit configuration to add your tables:â€
echo â€œ   ./edit_config.shâ€
echo â€œâ€
echo â€œ2. Test connectivity:â€
echo â€œ   ./test_connection.shâ€
echo â€œâ€
echo â€œ3. Run your first comparison:â€
echo â€œ   ./run_comparison.shâ€
echo â€œâ€
echo â€œðŸ“ Important files:â€
echo â€œ   config.yaml     - Main configurationâ€
echo â€œ   .env           - Database passwords (secure)â€
echo â€œ   run_comparison.sh - Run comparisonsâ€
echo â€œ   test_connection.sh - Test connectivityâ€
echo â€œ   edit_config.sh - Edit configurationâ€
echo â€œâ€
echo â€œðŸ“Š Output directories (created after first run):â€
echo â€œ   DB_Sentinel_report/ - Comparison reportsâ€
echo â€œ   DB_Sentinel_sql/    - Generated SQL filesâ€
echo â€œ   DB_Sentinel_audit/  - Audit logsâ€
echo â€œâ€
echo -e â€œ${YELLOW}âš ï¸  Remember to update config.yaml with your table details!${NC}â€
echo â€œâ€
EOF
